<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>did_notebook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="DID_notebook_files/libs/clipboard/clipboard.min.js"></script>
<script src="DID_notebook_files/libs/quarto-html/quarto.js"></script>
<script src="DID_notebook_files/libs/quarto-html/popper.min.js"></script>
<script src="DID_notebook_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="DID_notebook_files/libs/quarto-html/anchor.min.js"></script>
<link href="DID_notebook_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="DID_notebook_files/libs/quarto-html/quarto-syntax-highlighting-2486e1f0a3ee9ee1fc393803a1361cdb.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="DID_notebook_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="DID_notebook_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="DID_notebook_files/libs/bootstrap/bootstrap-13bb6caccc439c638c8b690b3ef045f7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="difference-in-differences-did-analysis" class="level1">
<h1>Difference-in-Differences (DID) Analysis</h1>
<p>In this notebook, we we estimate the effect of Trump’s calls for liberation in three specific states on compliance with state lockdown restrictions using a Difference-in-Differences (DID) approach. The authors compare Republican counties in the treated and control states. We use data from the Google Mobility Reports. The original study is by Dickson &amp; Hobolt in APSR (2024).</p>
</section>
<section id="first-we-install-the-necessary-libraries-and-load-the-data" class="level1">
<h1>First we install the necessary libraries and load the data</h1>
<p>The data can be downloaded from Github <a href="https://github.com/z-dickson/my580-causal-inference/data/google_mobility_data.csv">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install libraries (if not already installed)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("tidyverse")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("fixest")</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># load libraries </span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest) <span class="co"># for fixed effects regression</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># for data manipulation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.4     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data from Github  </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#data &lt;- read_csv("https://github.com/z-dickson/my580-causal-inference/data/google_mobility_data.csv")</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../data/google_mobility_data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 14631 Columns: 17
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr   (3): state_name, state_governor_party, winning_party
dbl  (13): county, retail_and_recreation_mobility, grocery_and_pharmacy_mobi...
date  (1): date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print the first few rows</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 17
  county date       state_name retail_and_recreation_mo…¹ grocery_and_pharmacy…²
   &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;                           &lt;dbl&gt;                  &lt;dbl&gt;
1   1001 2020-04-10 Alabama                           -30                     12
2   1001 2020-04-11 Alabama                           -37                     16
3   1001 2020-04-12 Alabama                           -55                    -51
4   1001 2020-04-13 Alabama                           -22                     -3
5   1001 2020-04-14 Alabama                           -23                      0
6   1001 2020-04-15 Alabama                           -11                      8
# ℹ abbreviated names: ¹​retail_and_recreation_mobility,
#   ²​grocery_and_pharmacy_mobility
# ℹ 12 more variables: parks_mobility &lt;dbl&gt;, transit_mobility &lt;dbl&gt;,
#   workplaces_mobility &lt;dbl&gt;, residential_mobility &lt;dbl&gt;, fips &lt;dbl&gt;,
#   state_governor_party &lt;chr&gt;, cases_x &lt;dbl&gt;, deaths_x &lt;dbl&gt;, dem_votes &lt;dbl&gt;,
#   rep_votes &lt;dbl&gt;, total_votes &lt;dbl&gt;, winning_party &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="data-cleaning" class="level1">
<h1>Data Cleaning</h1>
<p>Usually, we would need to clean the data before we can use it for analysis. However, the data is already mostly clean. We will make some key adjustments to for demonstration purposes.</p>
</section>
<section id="lets-create-a-column-for-aggregate_mobility" class="level1">
<h1>Let’s create a column for <code>aggregate_mobility</code></h1>
<p>In the analysis, we will use an aggregate measure of mobility that combines all types of mobility (e.g., retail, grocery, parks, etc.). We will create a new column called <code>aggregate_mobility</code> that sums up all the mobility measures for each observation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create variable for aggregate mobility by adding all the mobility variables </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>aggregate_mobility <span class="ot">=</span> data<span class="sc">$</span>retail_and_recreation_mobility <span class="sc">+</span> data<span class="sc">$</span>grocery_and_pharmacy_mobility <span class="sc">+</span> data<span class="sc">$</span>parks_mobility <span class="sc">+</span> data<span class="sc">$</span>transit_mobility <span class="sc">+</span> data<span class="sc">$</span>workplaces_mobility <span class="sc">+</span> data<span class="sc">$</span>residential_mobility</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check the new column</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(data<span class="sc">$</span>aggregate_mobility)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DID_notebook_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="lets-create-a-column-for-the-treatment-and-control-groups" class="level1">
<h1>Let’s create a column for the treatment and control groups</h1>
<p>The treatment group is the states where Trump called for liberation (Michigan, Minnesota, and Virginia) and the control group is the states where he did not (all other states).</p>
<p><strong>Note</strong>: In the actual study, the treatment group is defined as the states where Trump called for liberation and the control group is the states that were under the same lockdown restrictions but were not targeted in Trump’s calls for liberation. We’ll subset the data so that only Republican states are included in the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a variable for treatment and control groups</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>targeted_states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Michigan"</span>, <span class="st">"Minnesota"</span>, <span class="st">"Virginia"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">ifelse</span>(state_name <span class="sc">%in%</span> targeted_states, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># subset the data to include only Republican states</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#data &lt;- data %&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  filter(winning_party == "REPUBLICAN")</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># check the treatment variable</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data<span class="sc">$</span>treatment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1 
12938  1693 </code></pre>
</div>
</div>
</section>
<section id="lets-create-the-pre-post-and-treatment-control-variables" class="level1">
<h1>Let’s create the pre-post and treatment-control variables</h1>
<p>The pre-post variable indicates whether the observation is before or after Trump’s calls for liberation. Trump’s messages were on April 17, 2020, so we will use that as the cutoff date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a variable for pre-post and treatment-control</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">post =</span> <span class="fu">ifelse</span>(date <span class="sc">&lt;</span> <span class="st">"2020-04-17"</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># check the pre-post and treatment-control variables - we'll print all the dates that appear in the data when the pre_post variable is 1</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(data[data<span class="sc">$</span>post <span class="sc">==</span> <span class="dv">1</span>, <span class="st">'date'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 1
  date      
  &lt;date&gt;    
1 2020-04-17
2 2020-04-18
3 2020-04-19
4 2020-04-20
5 2020-04-21
6 2020-04-22
7 2020-04-23</code></pre>
</div>
</div>
</section>
<section id="lets-estimate-the-effect-of-trumps-calls-for-liberation-on-compliance-with-state-lockdown-restrictions-using-a-difference-in-differences-did-approach" class="level1">
<h1>Let’s estimate the effect of Trump’s calls for liberation on compliance with state lockdown restrictions using a Difference-in-Differences (DID) approach</h1>
<p>We will use a fixed effects regression model to estimate the effect of Trump’s calls for liberation on compliance with state lockdown restrictions. The model is specified as follows:</p>
<p><span class="math display">\[Y_{it} = \alpha_i + \lambda_t + \delta (\text{treated}_i * \text{post}_t) + \epsilon_{it}\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(Y_{it}\)</span> = Mobility for state <span class="math inline">\(i\)</span> on day <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(\alpha_i\)</span> = state fixed effects</li>
<li><span class="math inline">\(lambda_t\)</span> = day fixed effects</li>
<li><span class="math inline">\(\delta\)</span> = estimated causal effect of the treatment</li>
<li><span class="math inline">\(\text{treated}_i\)</span> = indicator for treated states</li>
<li><span class="math inline">\(\text{post}_t\)</span> = indicator for post-treatment period</li>
<li><span class="math inline">\(\epsilon_{it}\)</span> = error term</li>
</ul>
<section id="a-note-on-notation" class="level2">
<h2 class="anchored" data-anchor-id="a-note-on-notation">A note on notation</h2>
<p>It is worth mentioning that the equation above is effectively the same as the following:</p>
<p><span class="math display">\[Y_{it} = \alpha_i + \lambda_t + \delta \text{treatment}_{it} + \epsilon_{it}\]</span></p>
<p>where <span class="math inline">\(\text{treatment}_{it} = \text{treated}_i * \text{post}_t\)</span>.</p>
<p>This is because the interaction term <span class="math inline">\(\text{treated}_i * \text{post}_t\)</span> is effectively creating a variable that is 1 for treated states in the post-treatment period and 0 otherwise, and the fixed effects absorb the dummy variables. This is the essence of the Difference-in-Differences (DID) approach.</p>
<p>This equation is also effectively the same as the following:</p>
<p><span class="math display">\[Y_{it} = \beta_{0} \text{treated} + \beta_{1} \text{post} + \delta (\text{treated}_i * \text{post}_t) + \epsilon_{it}\]</span></p>
<p>Here, <span class="math inline">\(\beta_{0}\)</span> captures the average difference between treated and not-treated units. <span class="math inline">\(\beta_{1}\)</span> captures the average difference pre- and post-treatment. And <span class="math inline">\(\delta\)</span> captures the difference in these two differences; hence, the name “Difference-in-Differences.”</p>
</section>
</section>
<section id="estimating-the-model" class="level1">
<h1>Estimating the model</h1>
<p>There are many ways to estimate a DID model. Here, we will use the <code>fixest</code> package in R.</p>
<p><code>Fixest</code> syntax using a <code>|</code> to separate the fixed effects from the rest of the formula. Our syntax will look like the following:</p>
<p>Our <span class="math inline">\(Y_{it}\)</span> is mobility (<code>aggregate_mobility</code>) in county <span class="math inline">\(i\)</span> (<code>county</code>) on day <span class="math inline">\(t\)</span> (<code>date</code>).</p>
<p>We will cluster the standard errors at the county level to account for potential correlation within counties.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the DID model</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>did_model <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="at">fml =</span> aggregate_mobility <span class="sc">~</span> treatment <span class="sc">*</span> post <span class="sc">|</span> county <span class="sc">+</span> date, <span class="at">data =</span> data, <span class="at">vcov =</span> <span class="sc">~</span> county)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The variables 'treatment' and 'post' have been removed because of collinearity (see $collin.var).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(did_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: aggregate_mobility
Observations: 14,631
Fixed-effects: county: 1,046,  date: 14
Standard-errors: Clustered (county) 
               Estimate Std. Error t value  Pr(&gt;|t|)    
treatment:post  6.16538    2.06499 2.98568 0.0028954 ** 
... 2 variables were removed because of collinearity (treatment and post)
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 28.6     Adj. R2: 0.758803
             Within R2: 0.001191</code></pre>
</div>
</div>
</section>
<section id="interpretation-of-the-results" class="level1">
<h1>Interpretation of the results</h1>
<p>The coefficient of the interaction term <code>treatment * pre_post</code> in the model output is the estimated causal effect of Trump’s calls for liberation on compliance with state lockdown restrictions, given that our model is specified correctly and the assumptions of the DID approach hold.</p>
<p>The coefficient of the interaction term is the difference-in-differences estimate. It tells us how much the treatment group (states where Trump called for liberation) changed relative to the control group (states where he did not) after the treatment (Trump’s calls for liberation) compared to before the treatment.</p>
<p>The coefficient estimate is the <strong>cumulative effect</strong> of the treatment over the post-treatment period. Because the ‘post-treatment’ period in the data covers 1-week, the coefficient estimate is the cumulative effect of the treatment over that 1-week period. Hence, the cumulative ATT is about 6 percentage point, given that the outcome variable is in percentage points.</p>
</section>
<section id="what-if-we-want-to-estimate-the-dynamic-effects-of-the-treatment-over-time" class="level1">
<h1>What if we want to estimate the dynamic effects of the treatment over time?</h1>
<p>One of the key advantages to DiD is that we can estimate the dynamic effects of the treatment over time. This is typically referred to as the <em>event study</em> approach. Many libraries in R can help us estimate the event study approach. Here, we will use the <code>fixest</code> package to estimate the event study approach.</p>
<p>There are a few things we need to do to prepare the data. First, we need to convert the date variable to an integer. This is because the <code>Fixest</code> library uses a format where the holdout date is specified as an integer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert the date variable to an integer</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>date_int <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">as.factor</span>(data<span class="sc">$</span>date))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check the data by printing a dictionary of the date and the date_int variables</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(data[<span class="fu">c</span>(<span class="st">'date'</span>, <span class="st">'date_int'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 2
   date       date_int
   &lt;date&gt;        &lt;int&gt;
 1 2020-04-10        1
 2 2020-04-11        2
 3 2020-04-12        3
 4 2020-04-13        4
 5 2020-04-14        5
 6 2020-04-15        6
 7 2020-04-16        7
 8 2020-04-17        8
 9 2020-04-18        9
10 2020-04-19       10
11 2020-04-20       11
12 2020-04-21       12
13 2020-04-22       13
14 2020-04-23       14</code></pre>
</div>
</div>
</section>
<section id="estimating-the-event-study-model" class="level1">
<h1>Estimating the event study model</h1>
<p>We’ll use April 17 – the date of the messages – as the holdout period. This means that the holdout period will be 8 (see above).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the event study model</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>event_study <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="at">fml =</span> aggregate_mobility <span class="sc">~</span> <span class="fu">i</span>(date_int, treatment, <span class="at">ref =</span> <span class="dv">7</span>) <span class="sc">|</span> county <span class="sc">+</span> date_int, <span class="at">data =</span> data, <span class="at">vcov =</span> <span class="sc">~</span> county)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(event_study)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: aggregate_mobility
Observations: 14,631
Fixed-effects: county: 1,046,  date_int: 14
Standard-errors: Clustered (county) 
                        Estimate Std. Error   t value   Pr(&gt;|t|)    
date_int::1:treatment   3.664191    2.70302  1.355590 1.7552e-01    
date_int::2:treatment  20.304885    4.30669  4.714734 2.7478e-06 ***
date_int::3:treatment   7.805141    4.89645  1.594041 1.1123e-01    
date_int::4:treatment  -3.694608    2.40172 -1.538320 1.2427e-01    
date_int::5:treatment  -6.965171    2.15779 -3.227916 1.2857e-03 ** 
date_int::6:treatment  -9.898072    2.03987 -4.852313 1.4060e-06 ***
date_int::8:treatment   2.634199    2.89685  0.909331 3.6339e-01    
date_int::9:treatment  19.571363    4.44091  4.407059 1.1559e-05 ***
date_int::10:treatment 28.580718    4.80915  5.942985 3.8094e-09 ***
date_int::11:treatment -4.058299    3.43856 -1.180231 2.3818e-01    
date_int::12:treatment -0.570839    1.83237 -0.311531 7.5546e-01    
date_int::13:treatment  7.004225    3.22118  2.174425 2.9897e-02 *  
date_int::14:treatment  1.191841    2.66364  0.447448 6.5464e-01    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 28.4     Adj. R2: 0.761797
             Within R2: 0.01446 </code></pre>
</div>
</div>
</section>
<section id="plot-the-event-study-results" class="level1">
<h1>Plot the event study results</h1>
<p>We can plot the event study results to visualize the dynamic effects of the treatment over time. Using the <code>Fixest</code> library, we can use the <code>iplot</code> function to plot the event study results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">iplot</span>(event_study)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DID_notebook_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="how-can-we-improve-the-analysis" class="level1">
<h1>How can we improve the analysis?</h1>
<p>There are several ways to improve the analysis:</p>
<ul>
<li>Use a better estimator: While the fixed effects estimator is consistent and robust, it may not be the most efficient estimator. Other estimators, such as synthetic control, matrix completion, or other machine learning methods, may provide more precise estimates.</li>
<li>Include more control variables: Adding more control variables can help reduce bias and improve the precision of the estimates.</li>
<li>Check for parallel trends: The parallel trends assumption is crucial for the validity of the DID approach. Checking for parallel trends visually or using statistical tests can help ensure the validity of the estimates.</li>
<li>Test for sensitivity: Conducting sensitivity analyses, such as placebo tests or robustness checks, can help assess the robustness of the estimates to different model specifications or assumptions.</li>
</ul>
</section>
<section id="extension" class="level1">
<h1>Extension</h1>
<p>In Dickson &amp; Hobolt (2024), we use matrix completion methods to estimate a counterfactual using the data from the control states. We then compare the actual treatment effect to the counterfactual to estimate the causal effect of Trump’s calls for liberation. That’s beyond the scope of this notebook, but I’ll include the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install packages if they are not already installed</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># List of package names to install</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>packages_to_install <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"fect"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if each package is already installed</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (package_name <span class="cf">in</span> packages_to_install) {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(package_name <span class="sc">%in%</span> <span class="fu">installed.packages</span>())) {</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If not installed, install the package</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(package_name)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'GGally':
  method from   
  +.gg   ggplot2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a treatment variable that includes the interaction of treatment and post</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>treatment_post <span class="ot">&lt;-</span> data<span class="sc">$</span>treatment <span class="sc">*</span> data<span class="sc">$</span>post</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># function to estimate the matrix completion</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="cf">function</span>(data, formula) {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fect</span>(<span class="at">data =</span> data,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">formula =</span> formula,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">method =</span> <span class="st">"mc"</span>, </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">seed =</span> <span class="dv">42</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"county"</span>, <span class="st">"date_int"</span>),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">r =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">k =</span> <span class="dv">10</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">CV =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">nlambda =</span> <span class="dv">15</span>, </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">se =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">parallel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">cores =</span> <span class="dv">16</span>, <span class="co"># adjust accordingly </span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">nboots =</span> <span class="dv">200</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the matrix completion model</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>full_state_aggregate <span class="ot">&lt;-</span> <span class="fu">estimate</span>(data, </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    aggregate_mobility <span class="sc">~</span> treatment_post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Parallel computing ...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Cross-validating ...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Criterion: Mean Squared Prediction Error</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Some units have too few pre-treatment observations. Remove them automatically in Cross-Validation.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Matrix completion method...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 1.00000; MSPE = 1159.02349; MSPTATT = 70.30134; MSE = 847.83330</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 0.58780; MSPE = 941.43640; MSPTATT = 44.70158; MSE = 585.56447</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 0.34551; MSPE = 801.87484; MSPTATT = 23.98195; MSE = 314.28532</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 0.20309; MSPE = 785.19466; MSPTATT = 10.43137; MSE = 135.10648</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>*</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 0.11938; MSPE = 785.38977; MSPTATT = 3.60446; MSE = 46.68507</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 0.07017; MSPE = 785.63686; MSPTATT = 1.24571; MSE = 16.13390</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm = 0.04125; MSPE = 786.09939; MSPTATT = 0.43064; MSE = 5.57675</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>

 lambda.norm* = 0.203091762090474</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Bootstrapping for uncertainties ... </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>200 runs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Cannot use full pre-treatment periods in the F test. The first period is removed.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print the results</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(full_state_aggregate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
fect.formula(formula = formula, data = data, index = c("county", 
    "date_int"), force = "two-way", r = c(0, 5), nlambda = 15, 
    CV = TRUE, k = 10, method = "mc", se = TRUE, nboots = 200, 
    parallel = TRUE, cores = 16, seed = 42)

ATT:
                            ATT  S.E. CI.lower CI.upper   p.value
Tr obs equally weighted   6.484 1.884    2.792    10.18 0.0005769
Tr units equally weighted    NA 1.900       NA       NA        NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the results</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(full_state_aggregate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="DID_notebook_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>